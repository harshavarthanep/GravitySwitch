<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gravity Switch: Neon Edition</title>
    <meta name="theme-color" content="#000000">
    <meta name="description" content="A minimalist, gravity-flipping endless runner.">
    
    <link rel="manifest" href="manifest.json?v=1" id="manifest-placeholder">

    <style>
        :root {
            --bg-top: #ffffff;
            --bg-bottom: #000000;
            --hero-color: #00ffff; /* Neon Cyan */
            --ui-font: 'Courier New', Courier, monospace;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #111;
            font-family: var(--ui-font);
            touch-action: none; 
            user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        /* HUD */
        .hud-top {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--hero-color);
            text-shadow: 0 0 5px var(--hero-color);
        }

        /* Menus */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 10, 0.9); /* Dark background for neon vibe */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            text-align: center;
            z-index: 10;
        }

        .hidden { display: none !important; }

        h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 5px;
            border-bottom: 4px solid var(--hero-color);
            display: inline-block;
            text-shadow: 0 0 10px var(--hero-color);
        }

        p { color: #ccc; margin-bottom: 2rem; max-width: 300px; line-height: 1.5; }

        button {
            background: transparent;
            color: var(--hero-color);
            border: 2px solid var(--hero-color);
            padding: 15px 40px;
            font-size: 1.2rem;
            font-family: var(--ui-font);
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s;
            margin: 10px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }

        button:active {
            transform: scale(0.95);
        }

        button.primary {
            background: var(--hero-color);
            color: #000;
            box-shadow: 0 0 15px var(--hero-color);
        }

        /* Sound Toggle */
        #sound-btn {
            pointer-events: auto;
            background: none;
            border: 2px solid var(--hero-color);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            padding: 0;
            color: var(--hero-color);
            margin: 0;
        }

        /* Tutorial Hint */
        #tutorial {
            position: absolute;
            bottom: 20%;
            width: 100%;
            text-align: center;
            color: var(--hero-color);
            font-size: 1rem;
            opacity: 0.7;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.3; } 50% { opacity: 1; text-shadow: 0 0 10px var(--hero-color); } 100% { opacity: 0.3; } }

        /* INSTALL POPUP STYLES */
        #install-modal {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: #111;
            padding: 20px;
            box-shadow: 0 0 20px var(--hero-color);
            border: 2px solid var(--hero-color);
            text-align: center;
            z-index: 1000;
            display: none;
            font-family: var(--ui-font);
            color: white;
        }
        
        #install-modal h3 {
            margin-top: 0;
            color: var(--hero-color);
            text-shadow: 0 0 5px var(--hero-color);
        }
        
        #install-btn {
            background: var(--hero-color);
            color: black;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-weight: bold;
        }
        
        #close-install {
            position: absolute;
            top: 5px;
            right: 10px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--hero-color);
        }
        
        .ios-instructions {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud-top">
            <span id="score-display">DIST: 0</span>
            <button id="sound-btn">ðŸ”Š</button>
        </div>
        <div id="tutorial" class="hidden">TAP TO FLIP GRAVITY</div>
    </div>

    <div id="start-screen" class="screen">
        <h1>GRAVITY SWITCH</h1>
        <p>Neon Edition. <br>Tap to flip gravity. <br>Beware the invisible obstacles.</p>
        <button class="primary" onclick="startGame()">PLAY</button>

        <button id="menu-install-btn" class="hidden primary" style="margin-top: 20px;">INSTALL GAME</button>
        
        <p style="font-size: 0.8rem; margin-top: 20px; color: #666;">v1.0.0 | H24 Creationz</p>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 style="border-color: #ff0055; text-shadow: 0 0 10px #ff0055;">CRASHED</h1>
        <p>DISTANCE: <span id="final-score" style="color: var(--hero-color); font-size: 1.5rem;">0</span></p>
        <p>HIGH SCORE: <span id="best-score" style="color: var(--hero-color);">0</span></p>
        <button class="primary" onclick="startGame()">RETRY</button>
        <button onclick="showHome()">MENU</button>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getFirestore, collection, addDoc, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
      import { getAuth, signInAnonymously } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    
      const firebaseConfig = {
          apiKey: "AIzaSyBXPG13z_eLyS__djctLi4i3VkEjGolL28",
          authDomain: "inkbladebyh24creationz.firebaseapp.com",
          projectId: "inkbladebyh24creationz",
          storageBucket: "inkbladebyh24creationz.firebasestorage.app",
          messagingSenderId: "1008887341044",
          appId: "1:1008887341044:web:0ce9a5057ec1b89933e3a1"
      };
    
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
    
      signInAnonymously(auth).then(() => {
          console.log("Connected to Cloud anonymously.");
      }).catch((error) => console.error("Cloud Error:", error));
    
      window.saveScoreToCloud = async function(score) {
        const user = auth.currentUser;
        if (user) {
          try {
            await addDoc(collection(db, "leaderboard"), {
              uid: user.uid,
              score: score,
              game: "GravitySwitch", // Updated game name
              date: serverTimestamp()
            });
          } catch (e) {
            console.error("Error adding score: ", e);
          }
        }
      };
    </script>

    <script>
        /** ENGINE CONFIGURATION **/
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'MENU'; 
        let score = 0;
        let highScore = localStorage.getItem('gravity_switch_highscore') || 0;
        let soundEnabled = true;
        let audioCtx;
        let gameSpeed = 6;
        let frames = 0;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        /** GAME OBJECTS **/
        const player = {
            x: 50, y: 0,
            size: 30,
            color: '#00ffff',
            vy: 0,
            gravity: 0.8,
            isTop: false // false = bottom, true = top
        };

        let obstacles = [];
        let particles = [];

        /** AUDIO SYSTEM **/
        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
        }

        function playSound(type) {
            if (!soundEnabled || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'flip') {
                // Quick zap up/down
                osc.type = 'sine';
                osc.frequency.setValueAtTime(player.isTop ? 600 : 300, now);
                osc.frequency.exponentialRampToValueAtTime(player.isTop ? 800 : 150, now + 0.1);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'crash') {
                // Glitchy crash
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(20, now + 0.3);
                gainNode.gain.setValueAtTime(0.4, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'score') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
        }

        document.getElementById('sound-btn').addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-btn').innerText = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
            initAudio();
        });

        /** GAME LOGIC **/
        function flipGravity() {
            if (gameState !== 'PLAYING') return;
            document.getElementById('tutorial').classList.add('hidden');
            
            // Instantly flip gravity direction
            player.gravity *= -1;
            player.isTop = player.gravity < 0;
            
            // Give a little velocity boost to snap faster
            player.vy = player.isTop ? -5 : 5;
            
            playSound('flip');
            createParticles(player.x + player.size/2, player.y + player.size/2, '#00ffff', 5);
        }

        function spawnObstacle() {
            // Determine if it spawns on top or bottom
            let isTopObstacle = Math.random() > 0.5;
            
            let width = 30 + Math.random() * 40;
            let height = 40 + Math.random() * 60;
            
            obstacles.push({
                x: canvas.width,
                y: isTopObstacle ? 0 : canvas.height - height,
                width: width,
                height: height,
                isTop: isTopObstacle,
                passed: false
            });
        }

        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 1.0,
                    color: color,
                    size: Math.random() * 5 + 2
                });
            }
        }

        function startGame() {
            initAudio();
            gameState = 'PLAYING';
            score = 0;
            gameSpeed = 7;
            frames = 0;
            obstacles = [];
            particles = [];
            
            player.y = canvas.height - player.size;
            player.vy = 0;
            player.gravity = 0.8;
            player.isTop = false;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('tutorial').classList.remove('hidden');
            document.getElementById('score-display').innerText = "DIST: 0";

            loop();
        }

        function gameOver() {
            gameState = 'GAMEOVER';
            playSound('crash');
            createParticles(player.x + player.size/2, player.y + player.size/2, '#ff0055', 30);
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('gravity_switch_highscore', highScore);
            }

            if (window.saveScoreToCloud) window.saveScoreToCloud(score);

            document.getElementById('final-score').innerText = score;
            document.getElementById('best-score').innerText = highScore;
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        function showHome() {
            gameState = 'MENU';
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }

        /** MAIN LOOP **/
        function loop() {
            if (gameState !== 'PLAYING') return;
            requestAnimationFrame(loop);
            frames++;

            // 1. Draw Split Background
            ctx.fillStyle = '#ffffff'; // Top White
            ctx.fillRect(0, 0, canvas.width, canvas.height / 2);
            ctx.fillStyle = '#000000'; // Bottom Black
            ctx.fillRect(0, canvas.height / 2, canvas.width, canvas.height / 2);

            // 2. Update & Draw Player
            player.vy += player.gravity;
            player.y += player.vy;

            // Floor & Ceiling Collision
            if (player.y > canvas.height - player.size) {
                player.y = canvas.height - player.size;
                player.vy = 0;
            } else if (player.y < 0) {
                player.y = 0;
                player.vy = 0;
            }

            // Draw Player with Neon Glow
            ctx.shadowBlur = 15;
            ctx.shadowColor = player.color;
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.size, player.size);
            ctx.shadowBlur = 0; // Reset shadow for other objects

            // Draw player trail
            if (frames % 3 === 0) {
                createParticles(player.x, player.y + player.size/2, player.color, 1);
            }

            // 3. Update & Draw Obstacles
            if (frames % Math.floor(80 - gameSpeed * 2) === 0) {
                spawnObstacle();
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.x -= gameSpeed;

                // Color depends on placement to create "camouflage" effect
                // Top obstacles are very light grey on white. Bottom are dark grey on black.
                ctx.fillStyle = obs.isTop ? '#f0f0f0' : '#0f0f0f';
                ctx.fillRect(obs.x, obs.y, obs.width, obs.height);

                // Collision Detection (AABB)
                if (player.x < obs.x + obs.width &&
                    player.x + player.size > obs.x &&
                    player.y < obs.y + obs.height &&
                    player.y + player.size > obs.y) {
                    gameOver();
                    return;
                }

                // Score counting
                if (!obs.passed && obs.x + obs.width < player.x) {
                    obs.passed = true;
                    score += 10;
                    document.getElementById('score-display').innerText = "DIST: " + score;
                    if (score % 100 === 0) {
                        gameSpeed += 0.5; // Increase difficulty
                        playSound('score');
                    }
                }

                // Remove off-screen
                if (obs.x + obs.width < 0) {
                    obstacles.splice(i, 1);
                }
            }

            // 4. Update Particles
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.size, p.size);
                ctx.globalAlpha = 1.0;
                if (p.life <= 0) particles.splice(i, 1);
            });
        }

        /** INPUT EVENTS **/
        window.addEventListener('mousedown', flipGravity);
        window.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            flipGravity();
        }, {passive: false});

        // Prevent scrolling spacebar
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                flipGravity();
            }
        });

    </script>

    <div id="install-modal">
        <span id="close-install" onclick="closeInstallModal()">X</span>
        <h3>INSTALL APP</h3>
        <p>Install Gravity Switch for full-screen arcade action.</p>
        
        <button id="install-btn" class="hidden">INSTALL NOW</button>
    
        <div id="ios-prompt" class="hidden ios-instructions">
            To install on iPhone:<br>
            1. Tap the <strong>Share</strong> button <span style="font-size:1.2rem">âŽ‹</span><br>
            2. Scroll down & tap <strong>Add to Home Screen</strong> âž•
        </div>
    </div>
    
    <script>
        let deferredPrompt;
        const installModal = document.getElementById('install-modal');
        const installBtn = document.getElementById('install-btn');
        const iosPrompt = document.getElementById('ios-prompt');
        const menuInstallBtn = document.getElementById('menu-install-btn');
    
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW failed: ', err));
            });
        }
    
        const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);
    
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installModal.style.display = 'block';
            installBtn.classList.remove('hidden');
            menuInstallBtn.classList.remove('hidden');
            installBtn.addEventListener('click', triggerInstall);
            menuInstallBtn.addEventListener('click', triggerInstall);
        });
        
        function triggerInstall() {
            installModal.style.display = 'none';
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        menuInstallBtn.classList.add('hidden');
                    } else {
                        menuInstallBtn.classList.add('hidden'); 
                    }
                    deferredPrompt = null;
                });
            }
        }
    
        if (isIos() && !isInStandaloneMode()) {
            installModal.style.display = 'block';
            installBtn.classList.add('hidden');
            iosPrompt.classList.remove('hidden');
        }
    
        function closeInstallModal() {
            installModal.style.display = 'none';
        }
    </script>  
    
</body>
</html>
